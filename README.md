# CVE-2020-11851
Remote Code Execution vulnerability on ArcSight Logger(via ArcSight ESM)

### Executive Summary
##### Vulnerability Background
There are about 685 companies that use HP ArcSight ESM. The companies using HP ArcSight ESM are most often found in United States and in the Computer Software industry. HP ArcSight ESM is most often used by companies with >10000 employees and >1000M dollars in revenue. 
The vulnerability is present in backup functionality of ArcSight Management Center(version: 2.7.1.2065.0) and requires authentication. This backup option works by using “expect” scripts of ArcSight Logger which use Tool Command Language (Tcl). The vulnerability allows attackers to execute arbitrary Tcl commands which can be executed in the related Tcl script. 

##### Conclusion
The server running the vulnerable software can be comprimised by attackers via the RCE vulnerability and become a beachhead from which an adversary could launch further attacks against the organization’s servers, culminating in a serious breach. This vulnerability can result in data loss, corruption, or disclosure to unauthorized parties, loss of accountability or denial of access. 

##### Recommendations
It is recommended to check Tcl security best practices for “expect” scripts. Basically, using braces in eval would be safe like below:

`eval puts $exploit   ;# vulnerable`  

`eval "puts $exploit" ;# vulnerable`  

`eval {puts $exploit} ;# safe` 

More information can be found here: https://wiki.tcl-lang.org/page/Injection+Attack

### Technical Background
This section details vectors of command injections that can be used to detect the vulnerability in ArcSight Management Center. The titles below can be used to reproduce the attack steps.

##### `Exploring the vulnerable backup option`
In administration tab, there is a backup option. 

As we can see, we can configure a remote backup server by using SCP protocol. After clicking on the “Save” button, I debugged the server processes by using the tool “pspy” which can be downloaded from here: https://github.com/DominicBreuker/pspy/releases

##### `Debugging the server & Root cause analysis`
After saving the backup configuration, I detected the application uses bash script for checking the SSH server like below (please look at PID 95427):

Here is the more detailed command(PID 95427) for explanation: 

sh /opt/arcsight/current/arcsight/arcmc/config/logger/`runexpect.sh` /opt/arcsight/current/arcsight/arcmc/bin/filetransfer/lib/ /opt/arcsight/current/arcsight/arcmc/bin/filetransfer/lib/`expect` /opt/arcsight/current/arcsight/arcmc/tmp/`scp.expect.dir.backup1` `UserSuppliedPassword` `UserSuppliedUsernameAndHostname` `UserSuppliedPortNumber` `UserSuppliedBackupDirectory`

Let’s look at the content of “runexpect.sh” and “scp.expect.dir.backup1”(expect script) before explaining the alghorithm of “runexpect.sh”.

Here is the content of “runexpect.sh”:
```
1.	#!/bin/sh  
2.	  
3.	# Set LD_LIBRARY_PATH  
4.	  
5.	export LD_LIBRARY_PATH=$1  
6.	echo "Assuming LD_LIBRARY_PATH in runexpect :" $LD_LIBRARY_PATH  
7.	shift  
8.	echo "Running command: $*"  
9.	$*  
10.	  
11.	exit $? 
```

And here is the content of the expect script called “scp.expect.dir.backup1” 
1.	set password [lindex $argv 0]  
2.	set host [lindex $argv 1]  
3.	set port [lindex $argv 2]  
4.	set dir [lindex $argv 3]  
5.	eval spawn ssh -p $port $host test -d $dir && echo exists  //Vulnerability begins here
6.	expect "*(yes/no)?*$" { send "yes\n" }  
7.	set timeout 600  
8.	expect "*assword:*$" { send "$password\n" } \  
9.	timeout { exit 1 }  
10.	set timeout -1  
11.	expect "\\$ $" 
As we can see, “runexpect.sh” sets the environment variable(LD_LIBRARY_PATH) and then execute “expect” binary by using “expect” script called “scp.expect.dir.backup1”. This “expect” script gets 4 arguments to use them in “ssh” command. 

##### Gaining the code execution
